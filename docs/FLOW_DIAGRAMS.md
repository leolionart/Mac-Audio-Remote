# Confirmation Pattern - Visual Flow Diagrams

## Overview Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MicDrop Bridge Architecture                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    ğŸ“± iOS Device              ğŸ’» macOS                ğŸŒ Browser
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Shortcuts  â”‚           â”‚   MicDrop   â”‚        â”‚   Chrome     â”‚
  â”‚     App     â”‚           â”‚   Server    â”‚        â”‚  Extension   â”‚
  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                         â”‚                       â”‚
         â”‚  1. POST /toggle-mic    â”‚                       â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚
         â”‚                         â”‚                       â”‚
         â”‚                         â”‚  2. Broadcast event   â”‚
         â”‚                         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
         â”‚                         â”‚                       â”‚
         â”‚                         â”‚                       â”‚  3. Click mute
         â”‚                         â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
         â”‚                         â”‚                       â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                         â”‚                       â”‚         â”‚ Google â”‚
         â”‚                         â”‚                       â”‚         â”‚  Meet  â”‚
         â”‚                         â”‚  4. POST /mic-state   â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚                         â”‚   {muted: true}       â”‚
         â”‚  5. Response            â”‚                       â”‚
         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚
         â”‚  {status: "ok"}         â”‚                       â”‚
         â”‚                         â”‚                       â”‚

         â±ï¸  Total: ~100ms
```

## Successful Confirmation Flow

```
Timeline: Successful Toggle (0ms â†’ 100ms)

iOS Shortcuts              MicDrop Server              Chrome Extension         Google Meet
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

     â”‚                            â”‚                            â”‚                      â”‚
     â”‚  POST /toggle-mic          â”‚                            â”‚                      â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚                      â”‚
     â”‚                            â”‚                            â”‚                      â”‚
  0msâ”‚                         10msâ”‚                            â”‚                      â”‚
     â”‚                            â”‚ Create continuation        â”‚                      â”‚
     â”‚                            â”‚ Broadcast "mute-mic"       â”‚                      â”‚
     â”‚                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚
     â”‚                            â”‚                            â”‚                      â”‚
     â”‚                            â”‚ â³ WAIT (max 3s)          â”‚                      â”‚
     â”‚                            â”‚                            â”‚                      â”‚
     â”‚                            â”‚                         20msâ”‚                      â”‚
     â”‚                            â”‚                            â”‚ Receive event        â”‚
     â”‚                            â”‚                            â”‚ Find mute button     â”‚
     â”‚                            â”‚                            â”‚                      â”‚
     â”‚                            â”‚                            â”‚   Click!             â”‚
     â”‚                            â”‚                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                            â”‚                            â”‚                   50msâ”‚
     â”‚                            â”‚                            â”‚                      â”‚ Toggle mic
     â”‚                            â”‚                            â”‚   Read state         â”‚
     â”‚                            â”‚                            â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                            â”‚                            â”‚   muted=true         â”‚
     â”‚                            â”‚                         60msâ”‚                      â”‚
     â”‚                            â”‚                            â”‚                      â”‚
     â”‚                            â”‚  POST /bridge/mic-state    â”‚                      â”‚
     â”‚                            â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                      â”‚
     â”‚                            â”‚  {muted: true}             â”‚                      â”‚
     â”‚                         70msâ”‚                            â”‚                      â”‚
     â”‚                            â”‚ âœ… Resume continuation     â”‚                      â”‚
     â”‚                            â”‚                            â”‚                      â”‚
     â”‚   Response: {status:"ok"}  â”‚                            â”‚                      â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚                      â”‚
  100ms                            â”‚                            â”‚                      â”‚
     â”‚                            â”‚                            â”‚                      â”‚
```

## Timeout Scenario

```
Timeline: Timeout (Extension Not Running)

iOS Shortcuts              MicDrop Server              Chrome Extension
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

     â”‚                            â”‚
     â”‚  POST /toggle-mic          â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                            â”‚
  0msâ”‚                         10msâ”‚
     â”‚                            â”‚ Create continuation
     â”‚                            â”‚ Broadcast "mute-mic"
     â”‚                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€X             âŒ Not running!
     â”‚                            â”‚
     â”‚                            â”‚ â³ WAIT (max 3s)
     â”‚                            â”‚
     â”‚                            â”‚
     â”‚         â±ï¸  1 second       â”‚
     â”‚                            â”‚
     â”‚                            â”‚
     â”‚         â±ï¸  2 seconds      â”‚
     â”‚                            â”‚
     â”‚                            â”‚
     â”‚         â±ï¸  3 seconds      â”‚
     â”‚                            â”‚
     â”‚                      3000msâ”‚
     â”‚                            â”‚ â° Timeout!
     â”‚                            â”‚ Resume with false
     â”‚                            â”‚
     â”‚  Response: {status:"timeout"}
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  3010ms                           â”‚
     â”‚                            â”‚
```

## Fast Mode (No Confirmation)

```
Timeline: Fast Toggle (0ms â†’ 1ms)

iOS Shortcuts              MicDrop Server              Chrome Extension
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

     â”‚                            â”‚                            â”‚
     â”‚  POST /toggle-mic/fast     â”‚                            â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚
     â”‚                            â”‚                            â”‚
  0msâ”‚                          1msâ”‚                            â”‚
     â”‚                            â”‚ Toggle state (optimistic)  â”‚
     â”‚                            â”‚ Broadcast event            â”‚
     â”‚                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚   Response: {status:"ok"}  â”‚                            â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚
   1ms                            â”‚                            â”‚
     â”‚                            â”‚                            â”‚
     â”‚                            â”‚                         20msâ”‚
     â”‚                            â”‚                            â”‚ Receive event
     â”‚                            â”‚                            â”‚ (late)
     â”‚                            â”‚                            â”‚

ğŸš€ Fast: 1ms latency
âš ï¸  Risk: No confirmation
```

## State Synchronization

```
State Flow: How State Stays In Sync

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      State Sources                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

     Google Meet UI             Chrome Extension          MicDrop Server
     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€             â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Mute Button  â”‚           â”‚  content.js  â”‚         â”‚ BridgeManagerâ”‚
    â”‚ [aria-label] â”‚           â”‚              â”‚         â”‚              â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                          â”‚                        â”‚
           â”‚ User clicks mute         â”‚                        â”‚
           â”‚                          â”‚                        â”‚
           â”‚  Read actual state       â”‚                        â”‚
           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                        â”‚
           â”‚  muted=true              â”‚                        â”‚
           â”‚                          â”‚                        â”‚
           â”‚                          â”‚  POST /mic-state       â”‚
           â”‚                          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
           â”‚                          â”‚  {muted: true}         â”‚
           â”‚                          â”‚                        â”‚
           â”‚                          â”‚                        â”‚  Update @Published
           â”‚                          â”‚                        â”‚  isMuted = true
           â”‚                          â”‚                        â”‚
           â”‚                          â”‚                        â”‚  Notify UI
           â”‚                          â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>
           â”‚                          â”‚                        â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                          â”‚                        â”‚         â”‚ MenuBar â”‚
           â”‚                          â”‚                        â”‚         â”‚  Icon   â”‚
           â”‚                          â”‚                        â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ… Single source of truth: Google Meet UI
âœ… Extension reads actual state (not assumed)
âœ… Server receives confirmed state
âœ… All UIs in sync
```

## Long-Polling Mechanism

```
Long-Polling Event Distribution

Extension 1                 MicDrop Server                Extension 2
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

     â”‚                            â”‚                            â”‚
     â”‚  GET /bridge/poll          â”‚                            â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚
     â”‚                            â”‚                            â”‚
     â”‚  â³ Connection held        â”‚   GET /bridge/poll         â”‚
     â”‚                            â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                            â”‚                            â”‚
     â”‚                            â”‚   â³ Connection held       â”‚
     â”‚                            â”‚                            â”‚
     â”‚                            â”‚                            â”‚
     â”‚                            â”‚  ğŸ“± iOS triggers toggle    â”‚
     â”‚                            â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                            â”‚                            â”‚
     â”‚                            â”‚ ğŸ“¢ Broadcast to ALL        â”‚
     â”‚                            â”‚                            â”‚
     â”‚  {event: "mute-mic"}       â”‚   {event: "mute-mic"}      â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                            â”‚                            â”‚
     â”‚  Start new poll            â”‚   Start new poll           â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                            â”‚                            â”‚

âœ… Multiple extensions supported
âœ… Events broadcast to all listeners
âœ… Auto-reconnect on receive
```

## Error Handling Flow

```
Error Scenarios and Handling

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Error Cases                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. Extension Not Running
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

   iOS â†’ Server â†’ X (no extension)
         â”‚
         â””â”€ Wait 3s â†’ Return {status: "timeout"}

   âœ… Handled: User knows extension isn't running

2. Network Error
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

   iOS Xâ”€ Server (network down)

   âœ… Handled: iOS Shortcuts shows network error

3. Invalid JSON
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

   Extension â†’ Server (malformed JSON)
                 â”‚
                 â””â”€ 400 Bad Request

   âœ… Handled: Server validates with Codable

4. Google Meet UI Changed
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

   Extension â†’ Meet (selector not found)
         â”‚
         â””â”€ Log error, no confirmation sent
                  â”‚
                  â””â”€ Server timeout

   âš ï¸  Partially handled: Need selector updates

5. Server Crash During Toggle
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

   iOS â†’ Server X (crash)

   âš ï¸  Unhandled: iOS sees network error
   ğŸ’¡ Future: Add heartbeat check

6. Multiple Concurrent Requests
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

   iOS1 â†’ Server â† iOS2
           â”‚
           â””â”€ All share confirmation queue
           â””â”€ All receive same confirmation

   âœ… Handled: Broadcast to all waiters
```

## Component Interaction

```
Detailed Component Diagram

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Components                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

iOS Shortcuts                                          Chrome Extension
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Shortcut   â”‚                                      â”‚  content.js  â”‚
â”‚    Action    â”‚                                      â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                                     â”‚
       â”‚ HTTP POST                                           â”‚ Long-poll
       â”‚                                                     â”‚
       â†“                                                     â†“

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚      MicDrop Server         â”‚
                    â”‚                             â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                    â”‚  â”‚   HTTPServer.swift  â”‚   â”‚
                    â”‚  â”‚                     â”‚   â”‚
                    â”‚  â”‚  Routes:            â”‚   â”‚
                    â”‚  â”‚  â€¢ POST /toggle-mic â”‚   â”‚
                    â”‚  â”‚  â€¢ GET /bridge/poll â”‚   â”‚
                    â”‚  â”‚  â€¢ POST /mic-state  â”‚   â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                    â”‚             â”‚              â”‚
                    â”‚             â†“              â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                    â”‚  â”‚ BridgeManager.swift â”‚   â”‚
                    â”‚  â”‚                     â”‚   â”‚
                    â”‚  â”‚  â€¢ @Published state â”‚   â”‚
                    â”‚  â”‚  â€¢ Continuations    â”‚   â”‚
                    â”‚  â”‚  â€¢ Event broadcast  â”‚   â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                    â”‚             â”‚              â”‚
                    â”‚             â†“              â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                    â”‚  â”‚ SettingsManager     â”‚   â”‚
                    â”‚  â”‚ MenuBarController   â”‚   â”‚
                    â”‚  â”‚ UpdateManager       â”‚   â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Flow

```
Request/Response Data Flow

1. Toggle Request
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

   iOS                                 Server

   POST /toggle-mic               â†’    {
   (no body)                              "method": "POST",
                                          "path": "/toggle-mic"
                                      }

                                      Process:
                                      â€¢ toggleWithConfirmation()
                                      â€¢ Wait max 3s

                                  â†    {
   Response                               "status": "ok",
                                          "muted": true
                                      }

2. Long-Poll Request
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

   Extension                           Server

   GET /bridge/poll              â†’     {
   (no body)                              "method": "GET",
                                          "path": "/bridge/poll"
                                      }

                                      Process:
                                      â€¢ waitForNextEvent()
                                      â€¢ Suspend until event

                                  â†    {
   Response (when event)                  "event": "mute-mic"
                                      }

3. Confirmation Request
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

   Extension                           Server

   POST /bridge/mic-state        â†’     {
   Content-Type: application/json         "method": "POST",
   {                                      "path": "/bridge/mic-state",
     "muted": true                        "body": {"muted": true}
   }                                   }

                                      Process:
                                      â€¢ updateMicState(true)
                                      â€¢ Resume continuations

                                  â†    {
   Response                               "status": "updated",
                                          "muted": true
                                      }
```

---

**Legend:**
- `â†’` HTTP Request
- `â†` HTTP Response
- `â”œâ”€>` Async operation
- `X` Failed/rejected
- `â³` Waiting state
- `âœ…` Success
- `âŒ` Failure
- `âš ï¸` Warning
