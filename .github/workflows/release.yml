name: Build and Release macOS App

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0, v1.2.3
  workflow_dispatch:  # Allows manual trigger from GitHub Actions tab

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Cache Swift packages
      uses: actions/cache@v4
      with:
        path: .build
        key: ${{ runner.os }}-spm-${{ hashFiles('Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-

    - name: Build release binary
      run: |
        swift build -c release

    - name: Create app bundle
      run: |
        # Create app bundle structure
        mkdir -p AudioRemote.app/Contents/MacOS
        mkdir -p AudioRemote.app/Contents/Resources

        # Copy binary
        cp .build/release/AudioRemote AudioRemote.app/Contents/MacOS/

        # Copy resources
        cp AudioRemote/Resources/Info.plist AudioRemote.app/Contents/
        cp AudioRemote/Resources/AppIcon.icns AudioRemote.app/Contents/Resources/

        # Make binary executable
        chmod +x AudioRemote.app/Contents/MacOS/AudioRemote

    - name: Create DMG
      run: |
        # Install create-dmg if not available
        brew install create-dmg || true

        # Create DMG
        create-dmg \
          --volname "Audio Remote" \
          --volicon "AudioRemote/Resources/AppIcon.icns" \
          --window-pos 200 120 \
          --window-size 600 400 \
          --icon-size 100 \
          --icon "AudioRemote.app" 175 190 \
          --hide-extension "AudioRemote.app" \
          --app-drop-link 425 190 \
          "AudioRemote.dmg" \
          "AudioRemote.app" || \
        hdiutil create -volname "Audio Remote" -srcfolder AudioRemote.app -ov -format UDZO AudioRemote.dmg

    - name: Create ZIP archive
      run: |
        zip -r AudioRemote.zip AudioRemote.app

    - name: Get version from tag
      id: get_version
      run: |
        if [ "${{ github.ref_type }}" == "tag" ]; then
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        else
          echo "VERSION=dev-$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        fi

    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          AudioRemote.dmg
          AudioRemote.zip
        body: |
          ## Audio Remote ${{ steps.get_version.outputs.VERSION }}

          Native macOS menu bar app for controlling microphone and speaker audio.

          ### Features
          - üé§ Toggle microphone on/off
          - üîä Control speaker volume (increase/decrease/mute)
          - üì± iOS Shortcuts integration via HTTP API
          - üåê Web UI for remote control
          - ‚ö°Ô∏è Ultra-fast ~1ms toggle latency with Core Audio

          ### Installation
          1. Download `AudioRemote.dmg`
          2. Open the DMG and drag Audio Remote to Applications
          3. Launch from Applications folder
          4. Grant microphone permissions when prompted

          ### Requirements
          - macOS 13.0 (Ventura) or later

          ### What's New
          See [FEATURES.md](https://github.com/leolionart/Mac-Audio-Remote/blob/main/FEATURES.md) for full changelog.
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload artifacts for manual runs
      if: github.event_name == 'workflow_dispatch'
      uses: actions/upload-artifact@v4
      with:
        name: AudioRemote-${{ steps.get_version.outputs.VERSION }}
        path: |
          AudioRemote.dmg
          AudioRemote.zip
        retention-days: 30
