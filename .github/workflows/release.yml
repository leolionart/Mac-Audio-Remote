name: Build and Release macOS App

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0, v1.2.3
  workflow_dispatch:  # Allows manual trigger from GitHub Actions tab

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Cache Swift packages
      uses: actions/cache@v4
      with:
        path: .build
        key: ${{ runner.os }}-spm-${{ hashFiles('Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-

    - name: Build release binary
      run: |
        swift build -c release

    - name: Create app bundle
      run: |
        # Create app bundle structure
        mkdir -p AudioRemote.app/Contents/MacOS
        mkdir -p AudioRemote.app/Contents/Resources
        mkdir -p AudioRemote.app/Contents/Frameworks

        # Copy binary
        cp .build/release/AudioRemote AudioRemote.app/Contents/MacOS/

        # Copy resources
        cp AudioRemote/Resources/Info.plist AudioRemote.app/Contents/
        if [ -f AudioRemote/Resources/AppIcon.icns ]; then
          cp AudioRemote/Resources/AppIcon.icns AudioRemote.app/Contents/Resources/
        fi
        if [ -d AudioRemote/Resources/Assets.xcassets ]; then
          cp -R AudioRemote/Resources/Assets.xcassets AudioRemote.app/Contents/Resources/
        fi

        # Copy resource bundle if it exists
        if [ -d .build/release/AudioRemote_AudioRemote.bundle ]; then
          cp -R .build/release/AudioRemote_AudioRemote.bundle AudioRemote.app/Contents/Resources/
        fi

        # Copy Sparkle framework (CRITICAL for auto-updates)
        if [ -d .build/release/Sparkle.framework ]; then
          cp -R .build/release/Sparkle.framework AudioRemote.app/Contents/Frameworks/
          echo "‚úì Copied Sparkle.framework"
        else
          echo "‚ö†Ô∏è Warning: Sparkle.framework not found"
        fi

        # Make binary executable
        chmod +x AudioRemote.app/Contents/MacOS/AudioRemote

        # Create PkgInfo
        echo "APPL????" > AudioRemote.app/Contents/PkgInfo

        # Fix rpath for frameworks
        install_name_tool -add_rpath "@executable_path/../Frameworks" AudioRemote.app/Contents/MacOS/AudioRemote 2>/dev/null || true

    - name: Create DMG
      run: |
        # Install create-dmg if not available
        brew install create-dmg || true

        # Create DMG
        create-dmg \
          --volname "Audio Remote" \
          --volicon "AudioRemote/Resources/AppIcon.icns" \
          --window-pos 200 120 \
          --window-size 600 400 \
          --icon-size 100 \
          --icon "AudioRemote.app" 175 190 \
          --hide-extension "AudioRemote.app" \
          --app-drop-link 425 190 \
          "AudioRemote.dmg" \
          "AudioRemote.app" || \
        hdiutil create -volname "Audio Remote" -srcfolder AudioRemote.app -ov -format UDZO AudioRemote.dmg

    - name: Create ZIP archive
      run: |
        # Get version from tag (v2.1.0 -> 2.1.0)
        VERSION=${GITHUB_REF#refs/tags/v}
        if [ -z "$VERSION" ] || [ "$VERSION" == "$GITHUB_REF" ]; then
          VERSION="dev"
        fi
        zip -r AudioRemote-${VERSION}.zip AudioRemote.app
        echo "Created AudioRemote-${VERSION}.zip"

    - name: Get version from tag
      id: get_version
      run: |
        if [ "${{ github.ref_type }}" == "tag" ]; then
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        else
          echo "VERSION=dev-$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        fi

    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          AudioRemote.dmg
          AudioRemote-*.zip
        body: |
          ## Audio Remote ${{ steps.get_version.outputs.VERSION }}

          Native macOS menu bar app for controlling microphone and speaker audio.

          ### ‚ú® What's New in this Release

          Check the commit history for detailed changes in this version.

          ### üéØ Core Features
          - üé§ Toggle microphone on/off with ultra-fast ~1ms latency
          - üîä Control speaker volume (increase/decrease/mute)
          - üñ•Ô∏è On-screen volume HUD overlay (macOS-style)
          - üîî Notifications for all audio operations
          - üì± iOS Shortcuts integration via HTTP API
          - üåê Web UI for remote control (http://YOUR_MAC_IP:8765)
          - ‚ö°Ô∏è Built with Swift + Core Audio for native performance
          - üîÑ Automatic updates via Sparkle

          ### üì• Installation
          1. Download `AudioRemote-${{ steps.get_version.outputs.VERSION }}.zip`
          2. Extract and move `AudioRemote.app` to Applications folder
          3. Launch from Applications folder
          4. Grant microphone and notification permissions when prompted

          ### ‚öôÔ∏è Requirements
          - macOS 13.0 (Ventura) or later
          - Microphone permission (for mic toggle)
          - Notification permission (for audio notifications)

          ### üì± iOS Shortcuts Integration
          Control your Mac remotely:
          ```
          POST http://YOUR_MAC_IP:8765/toggle-mic       # Toggle microphone
          POST http://YOUR_MAC_IP:8765/volume/increase   # Increase volume
          POST http://YOUR_MAC_IP:8765/volume/decrease   # Decrease volume
          POST http://YOUR_MAC_IP:8765/volume/toggle-mute # Mute/unmute
          GET  http://YOUR_MAC_IP:8765/status            # Get current status
          ```

          For full documentation, visit the [GitHub repository](https://github.com/leolionart/Mac-Audio-Remote).
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload artifacts for manual runs
      if: github.event_name == 'workflow_dispatch'
      uses: actions/upload-artifact@v4
      with:
        name: AudioRemote-${{ steps.get_version.outputs.VERSION }}
        path: |
          AudioRemote.dmg
          AudioRemote.zip
        retention-days: 30
