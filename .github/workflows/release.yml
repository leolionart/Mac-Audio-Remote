name: Build and Release macOS App

# DISABLED: Release builds happen locally to ensure EdDSA signature consistency.
# GitHub Actions creates different signatures which break Sparkle auto-update.
# See .claude/skills/release/SKILL.md for the correct release workflow.

on:
  # push:
  #   tags:
  #     - 'v*.*.*'  # Triggers on version tags like v1.0.0, v1.2.3
  workflow_dispatch:  # Allows manual trigger from GitHub Actions tab (for testing only)

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Cache Swift packages
      uses: actions/cache@v4
      with:
        path: .build
        key: ${{ runner.os }}-spm-${{ hashFiles('Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-

    - name: Build release binary
      run: |
        swift build -c release

    - name: Find and copy Sparkle framework
      run: |
        # SPM checkouts Sparkle to .build/checkouts/, need to find the built framework
        echo "üîç Searching for Sparkle.framework..."

        # Try common locations
        SPARKLE_PATHS=(
          ".build/release/Sparkle.framework"
          ".build/arm64-apple-macosx/release/Sparkle.framework"
          ".build/x86_64-apple-macosx/release/Sparkle.framework"
          ".build/checkouts/Sparkle/Sparkle.framework"
          ".build/artifacts/sparkle/Sparkle/Sparkle.framework"
        )

        SPARKLE_FOUND=""
        for path in "${SPARKLE_PATHS[@]}"; do
          if [ -d "$path" ]; then
            SPARKLE_FOUND="$path"
            echo "‚úì Found Sparkle.framework at: $path"
            break
          fi
        done

        if [ -z "$SPARKLE_FOUND" ]; then
          echo "‚ö†Ô∏è Sparkle.framework not found in standard locations"
          echo "üìÇ Searching entire .build directory..."
          find .build -name "Sparkle.framework" -type d 2>/dev/null || true

          # Try to build Sparkle manually from checkouts
          if [ -d ".build/checkouts/Sparkle" ]; then
            echo "üî® Building Sparkle from source..."
            cd .build/checkouts/Sparkle
            xcodebuild -scheme Sparkle -configuration Release -derivedDataPath ./DerivedData
            cd ../../..
            SPARKLE_FOUND=".build/checkouts/Sparkle/DerivedData/Build/Products/Release/Sparkle.framework"
          fi
        fi

        # Copy to .build/release for consistency with local build (only if not already there)
        if [ -n "$SPARKLE_FOUND" ] && [ -d "$SPARKLE_FOUND" ]; then
          mkdir -p .build/release

          # Only copy if source and destination are different
          if [ "$SPARKLE_FOUND" != ".build/release/Sparkle.framework" ]; then
            cp -R "$SPARKLE_FOUND" .build/release/
            echo "‚úì Copied Sparkle.framework to .build/release/"
          else
            echo "‚úì Sparkle.framework already in .build/release/"
          fi
        else
          echo "‚ùå ERROR: Could not find or build Sparkle.framework"
          exit 1
        fi

    - name: Create app bundle
      run: |
        # Use the tested build script
        chmod +x build_app_bundle.sh

        # Modify script to use current directory instead of .build/release/
        APP_NAME="AudioRemote"
        BUILD_DIR=".build/release"

        # Create app bundle structure
        mkdir -p AudioRemote.app/Contents/MacOS
        mkdir -p AudioRemote.app/Contents/Resources
        mkdir -p AudioRemote.app/Contents/Frameworks

        # Copy binary
        cp $BUILD_DIR/$APP_NAME AudioRemote.app/Contents/MacOS/

        # Copy Info.plist
        cp AudioRemote/Resources/Info.plist AudioRemote.app/Contents/

        # Copy icon assets
        if [ -d AudioRemote/Resources/Assets.xcassets ]; then
          cp -R AudioRemote/Resources/Assets.xcassets AudioRemote.app/Contents/Resources/
        fi

        # Copy Resources bundle
        if [ -d $BUILD_DIR/AudioRemote_AudioRemote.bundle ]; then
          cp -R $BUILD_DIR/AudioRemote_AudioRemote.bundle AudioRemote.app/Contents/Resources/

          # Copy AppIcon.icns to Resources root for Finder icon
          if [ -f $BUILD_DIR/AudioRemote_AudioRemote.bundle/Resources/AppIcon.icns ]; then
            cp $BUILD_DIR/AudioRemote_AudioRemote.bundle/Resources/AppIcon.icns AudioRemote.app/Contents/Resources/
          fi
        fi

        # Copy Sparkle framework (CRITICAL)
        if [ -d $BUILD_DIR/Sparkle.framework ]; then
          cp -R $BUILD_DIR/Sparkle.framework AudioRemote.app/Contents/Frameworks/
          echo "‚úì Copied Sparkle.framework to app bundle"
        else
          echo "‚ùå ERROR: Sparkle.framework not found in $BUILD_DIR"
          exit 1
        fi

        # Set executable permission
        chmod +x AudioRemote.app/Contents/MacOS/$APP_NAME

        # Create PkgInfo
        echo "APPL????" > AudioRemote.app/Contents/PkgInfo

        # Fix rpath for frameworks
        install_name_tool -add_rpath "@executable_path/../Frameworks" AudioRemote.app/Contents/MacOS/$APP_NAME 2>/dev/null || true

        echo "‚úÖ App bundle created successfully"

    - name: Create DMG
      run: |
        # Install create-dmg if not available
        brew install create-dmg || true

        # Create DMG
        create-dmg \
          --volname "Audio Remote" \
          --volicon "AudioRemote/Resources/AppIcon.icns" \
          --window-pos 200 120 \
          --window-size 600 400 \
          --icon-size 100 \
          --icon "AudioRemote.app" 175 190 \
          --hide-extension "AudioRemote.app" \
          --app-drop-link 425 190 \
          "AudioRemote.dmg" \
          "AudioRemote.app" || \
        hdiutil create -volname "Audio Remote" -srcfolder AudioRemote.app -ov -format UDZO AudioRemote.dmg

    - name: Create ZIP archive
      run: |
        # Get version from tag (v2.1.0 -> 2.1.0)
        VERSION=${GITHUB_REF#refs/tags/v}
        if [ -z "$VERSION" ] || [ "$VERSION" == "$GITHUB_REF" ]; then
          VERSION="dev"
        fi
        zip -r AudioRemote-${VERSION}.zip AudioRemote.app
        echo "Created AudioRemote-${VERSION}.zip"

    - name: Sign ZIP with EdDSA
      env:
        SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_EDDSA_PRIVATE_KEY }}
      run: |
        # Get version from tag
        VERSION=${GITHUB_REF#refs/tags/v}
        if [ -z "$VERSION" ] || [ "$VERSION" == "$GITHUB_REF" ]; then
          VERSION="dev"
        fi

        # Download and extract Sparkle tools
        echo "üì• Downloading Sparkle tools..."
        curl -L -o /tmp/Sparkle.tar.xz \
          https://github.com/sparkle-project/Sparkle/releases/download/2.6.4/Sparkle-2.6.4.tar.xz
        mkdir -p /tmp/sparkle
        tar -xf /tmp/Sparkle.tar.xz -C /tmp/sparkle

        # Create temporary private key file
        echo "$SPARKLE_PRIVATE_KEY" > /tmp/sparkle_private_key.txt

        # Sign the ZIP file
        echo "üîê Signing ZIP with EdDSA..."
        SIGNATURE_OUTPUT=$(/tmp/sparkle/bin/sign_update \
          --ed-key-file /tmp/sparkle_private_key.txt \
          AudioRemote-${VERSION}.zip 2>&1)

        echo "Signature output: $SIGNATURE_OUTPUT"

        # Extract signature for verification
        ED_SIGNATURE=$(echo "$SIGNATURE_OUTPUT" | grep -o 'sparkle:edSignature="[^"]*"' | cut -d'"' -f2)

        if [ -z "$ED_SIGNATURE" ]; then
          echo "‚ùå Failed to sign ZIP file"
          echo "Output: $SIGNATURE_OUTPUT"
          exit 1
        fi

        echo "‚úÖ ZIP signed successfully"
        echo "EdDSA Signature: $ED_SIGNATURE"

        # Clean up private key
        rm -f /tmp/sparkle_private_key.txt

        # Save signature to output for later use
        echo "ED_SIGNATURE=$ED_SIGNATURE" >> $GITHUB_OUTPUT

    - name: Get version from tag
      id: get_version
      run: |
        if [ "${{ github.ref_type }}" == "tag" ]; then
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        else
          echo "VERSION=dev-$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        fi

    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          AudioRemote.dmg
          AudioRemote-*.zip
        body: |
          ## Audio Remote ${{ steps.get_version.outputs.VERSION }}

          Native macOS menu bar app for controlling microphone and speaker audio.

          ### ‚ú® What's New in this Release

          Check the commit history for detailed changes in this version.

          ### üéØ Core Features
          - üé§ Toggle microphone on/off with ultra-fast ~1ms latency
          - üîä Control speaker volume (increase/decrease/mute)
          - üñ•Ô∏è On-screen volume HUD overlay (macOS-style)
          - üîî Notifications for all audio operations
          - üì± iOS Shortcuts integration via HTTP API
          - üåê Web UI for remote control (http://YOUR_MAC_IP:8765)
          - ‚ö°Ô∏è Built with Swift + Core Audio for native performance
          - üîÑ Automatic updates via Sparkle

          ### üì• Installation
          1. Download `AudioRemote-${{ steps.get_version.outputs.VERSION }}.zip`
          2. Extract and move `AudioRemote.app` to Applications folder
          3. Launch from Applications folder
          4. Grant microphone and notification permissions when prompted

          ### ‚öôÔ∏è Requirements
          - macOS 13.0 (Ventura) or later
          - Microphone permission (for mic toggle)
          - Notification permission (for audio notifications)

          ### üì± iOS Shortcuts Integration
          Control your Mac remotely:
          ```
          POST http://YOUR_MAC_IP:8765/toggle-mic       # Toggle microphone
          POST http://YOUR_MAC_IP:8765/volume/increase   # Increase volume
          POST http://YOUR_MAC_IP:8765/volume/decrease   # Decrease volume
          POST http://YOUR_MAC_IP:8765/volume/toggle-mute # Mute/unmute
          GET  http://YOUR_MAC_IP:8765/status            # Get current status
          ```

          For full documentation, visit the [GitHub repository](https://github.com/leolionart/Mac-Audio-Remote).
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload artifacts for manual runs
      if: github.event_name == 'workflow_dispatch'
      uses: actions/upload-artifact@v4
      with:
        name: AudioRemote-${{ steps.get_version.outputs.VERSION }}
        path: |
          AudioRemote.dmg
          AudioRemote.zip
        retention-days: 30
